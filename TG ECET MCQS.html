<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Leveling ECET Quiz - Dungeon Instance</title>
    <style>
        /* --- SOLO LEVELING / DUNGEON THEME CSS --- */
        :root {
            --dark-bg: #101214;
            --stone-dark: #20242a;
            --stone-light: #3a4048;
            --rune-glow: #00ff7f; /* Sung Jinwoo's System Green */
            --warning-red: #ff4500;
            --text-light: #e0e0e0;
            --font-main: 'Orbitron', sans-serif; /* Tech/Futuristic Look */
            --font-body: 'Roboto', sans-serif;
            --header-shadow: 0 0 10px var(--rune-glow);
        }

        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;900&family=Roboto:wght@400;700&display=swap');

        body {
            font-family: var(--font-body);
            color: var(--text-light);
            background-color: var(--dark-bg);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-x: hidden;
            position: relative;
        }

        /* --- STARFIELD / PARTICLE ANIMATION BACKGROUND --- */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.2;
        }

        .container {
            background-color: var(--stone-dark);
            border: 3px solid var(--stone-light);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 15px var(--rune-glow);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        /* --- HEADERS & TEXT --- */
        h1, h2 {
            font-family: var(--font-main);
            text-align: center;
            color: var(--rune-glow);
            text-shadow: var(--header-shadow);
            margin-bottom: 20px;
        }
        
        .title-rune {
            font-size: 1.5em;
            display: block;
            margin-bottom: 5px;
        }

        /* --- BUTTONS (Rune-Style) --- */
        button {
            background: linear-gradient(45deg, var(--stone-light), var(--stone-dark));
            color: var(--rune-glow);
            border: 2px solid var(--rune-glow);
            padding: 12px 25px;
            font-family: var(--font-main);
            font-size: 1em;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px var(--rune-glow);
            margin: 10px 5px;
        }

        button:hover {
            background: var(--stone-light);
            box-shadow: 0 0 15px var(--rune-glow);
            transform: translateY(-2px);
        }

        button:disabled {
            background: #25282d;
            color: #555;
            border-color: #555;
            cursor: not-allowed;
            box-shadow: none;
            text-shadow: none;
        }

        /* --- INPUTS & FORMS --- */
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: var(--stone-light);
            border: 1px solid var(--rune-glow);
            color: var(--text-light);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--rune-glow);
            box-shadow: 0 0 8px var(--rune-glow);
        }

        /* --- QUIZ SCREEN SPECIFIC --- */
        #quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--stone-light);
        }

        .progress-bar {
            background-color: var(--stone-light);
            border: 1px solid var(--rune-glow);
            border-radius: 5px;
            overflow: hidden;
            height: 15px;
            flex-grow: 1;
            margin-left: 15px;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: var(--rune-glow);
            transition: width 0.3s ease;
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #1a1e22;
            border-left: 5px solid var(--rune-glow);
            border-radius: 4px;
        }

        .option-container button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            text-align: left;
            padding: 15px;
            font-size: 1em;
            white-space: normal; /* Allow text wrapping */
        }

        /* Feedback colors */
        .selected-option {
            box-shadow: 0 0 10px var(--warning-red);
            border-color: var(--warning-red);
            transform: scale(1.02);
        }
        
        /* Disable options after selection/submission */
        .option-container.disabled button:not(:disabled) {
            opacity: 0.6;
            cursor: default;
        }


        /* --- RESULTS SCREEN SPECIFIC --- */
        #results-content {
            text-align: center;
        }

        #score-display {
            font-family: var(--font-main);
            font-size: 3em;
            color: var(--rune-glow);
            text-shadow: 0 0 15px var(--rune-glow);
            margin: 20px 0;
        }

        #explanation-area {
            margin-top: 30px;
            padding: 15px;
            text-align: left;
            border-top: 2px solid var(--stone-light);
        }

        .explanation-card {
            background-color: #1a1e22;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 5px solid var(--warning-red);
        }

        .explanation-card h3 {
            color: var(--warning-red);
            font-family: var(--font-main);
            margin-top: 0;
        }

        .gemini-loading {
            color: var(--rune-glow);
            font-style: italic;
            text-align: center;
        }

        /* --- Error Screen --- */
        #error-screen {
            color: var(--warning-red);
            text-align: center;
        }

        /* --- Responsive Design --- */
        @media (max-width: 600px) {
            .container {
                width: 95%;
                padding: 15px;
            }
            #score-display {
                font-size: 2.5em;
            }
            .question-text {
                font-size: 1.1em;
            }
        }
    </style>
</head>
<body>
    <canvas id="starfield"></canvas>

    <div class="container" id="app-container">
        </div>

    <script>
        // --- VANILLA JAVASCRIPT LOGIC ---

        // GLOBAL STATE
        let currentScreen = 'welcome';
        let userName = localStorage.getItem('quizUserName') || '';
        let quizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = []; // [{ id: 'Q1', selected: 1, correct: 3, questionText: '...' }]
        let timeLimitSeconds = 600; // 10 minutes (60 seconds per Q approx for 10 Q)
        let timerInterval = null;
        let geminiApiKey = '';
        let totalQuestions = 0;

        const appContainer = document.getElementById('app-container');

        // --- CORE FUNCTIONS ---

        /**
         * Renders the current screen based on the global state.
         */
        function renderScreen() {
            appContainer.innerHTML = ''; // Clear previous content

            switch (currentScreen) {
                case 'welcome':
                    renderWelcomeScreen();
                    break;
                case 'quiz':
                    renderQuizScreen();
                    break;
                case 'results':
                    renderResultsScreen();
                    break;
                case 'error':
                    renderErrorScreen();
                    break;
            }
        }

        // --- PAGE RENDERERS ---

        /**
         * Renders the Welcome Screen.
         */
        function renderWelcomeScreen() {
            appContainer.innerHTML = `
                <header>
                    <h1><span class="title-rune">SYSTEM ALERT:</span> DUNGEON INSTANCE CREATED</h1>
                    <h2>A TG ECET Knowledge Check</h2>
                </header>
                <section id="welcome-content">
                    <p>Before entering the Gate, please identify yourself, Hunter.</p>
                    <input type="text" id="user-name" placeholder="Enter your name (e.g., Mahesh)" value="${userName}">
                    <p>You have **${Math.ceil(timeLimitSeconds / 60)} minutes** to complete **${totalQuestions} questions**.</p>
                    <button id="start-quiz-btn" disabled>LEVEL UP START</button>
                    <p style="margin-top: 20px;">***AI Integration Required***</p>
                    <input type="text" id="gemini-api-key" placeholder="Enter Gemini API Key (e.g., AIza...)">
                </section>
            `;

            const nameInput = document.getElementById('user-name');
            const startBtn = document.getElementById('start-quiz-btn');
            const keyInput = document.getElementById('gemini-api-key');

            // Pre-fill name if known from localStorage
            if (userName) nameInput.value = userName;
            
            // Enable button only if both name and key are provided
            const checkInputs = () => {
                userName = nameInput.value.trim();
                geminiApiKey = keyInput.value.trim();
                startBtn.disabled = !(userName && geminiApiKey && quizData.length > 0);
                if (quizData.length === 0) startBtn.textContent = 'Loading Questions...';
            };
            
            nameInput.addEventListener('input', checkInputs);
            keyInput.addEventListener('input', checkInputs);
            
            // Initial check for pre-filled data
            checkInputs(); 

            startBtn.addEventListener('click', () => {
                // Save name and start quiz
                if (userName && geminiApiKey) {
                    localStorage.setItem('quizUserName', userName);
                    startQuiz();
                }
            });
        }

        /**
         * Renders the Quiz Screen.
         */
        function renderQuizScreen() {
            if (currentQuestionIndex >= quizData.length) {
                // Should not happen if flow is correct, but safe check
                finishQuiz();
                return;
            }

            const q = quizData[currentQuestionIndex];
            const qNum = currentQuestionIndex + 1;

            appContainer.innerHTML = `
                <header id="quiz-header">
                    <div style="font-family: var(--font-main); font-size: 1.1em;">
                        Time Left: <span id="timer-display">${formatTime(timeLimitSeconds)}</span>
                    </div>
                    <div style="font-family: var(--font-main);">
                        Q ${qNum} / ${quizData.length}
                    </div>
                </header>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: ${((qNum - 1) / quizData.length) * 100}%;"></div>
                </div>
                
                <section id="quiz-content" style="margin-top: 20px;">
                    <p class="question-text">${q.question_text}</p>
                    <div class="option-container" id="option-container">
                        ${q.options.map((option, index) => 
                            `<button data-index="${index}">${String.fromCharCode(65 + index)}. ${option}</button>`
                        ).join('')}
                    </div>
                    <div style="text-align: right; margin-top: 20px;">
                        <button id="next-q-btn" disabled>SUBMIT & NEXT</button>
                    </div>
                </section>
            `;

            // Start or resume timer
            if (!timerInterval) startTimer();
            
            // Add option click handlers
            const optionContainer = document.getElementById('option-container');
            const nextBtn = document.getElementById('next-q-btn');
            let selectedOptionIndex = -1;

            optionContainer.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Visually mark selected option
                    optionContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('selected-option'));
                    e.currentTarget.classList.add('selected-option');
                    
                    selectedOptionIndex = parseInt(e.currentTarget.getAttribute('data-index'));
                    nextBtn.disabled = false; // Enable submit button
                });
            });

            // Add next/submit handler
            nextBtn.addEventListener('click', () => {
                if (selectedOptionIndex !== -1) {
                    recordAnswer(q, selectedOptionIndex);
                    
                    // Proceed to next question or finish quiz
                    currentQuestionIndex++;
                    if (currentQuestionIndex < quizData.length) {
                        renderScreen(); // Next question
                    } else {
                        finishQuiz(); // All questions answered
                    }
                }
            });
        }
        
        /**
         * Renders the Results Screen.
         */
        function renderResultsScreen() {
            clearInterval(timerInterval);
            const incorrectAnswers = userAnswers.filter(a => a.selected !== a.correct);
            const passStatus = score >= (quizData.length * 0.7) ? 'System: **DUNGEON CLEARED**' : 'System: **RETRY FAILED INSTANCE**';

            appContainer.innerHTML = `
                <header>
                    <h1>${passStatus}</h1>
                    <h2>Results for Hunter ${userName}</h2>
                </header>
                
                <section id="results-content">
                    <p style="font-size: 1.2em; font-family: var(--font-main);">Final Score:</p>
                    <div id="score-display">${score} / ${quizData.length}</div>
                    <p>Correct Answers: ${score}</p>
                    <p>Incorrect Answers: ${incorrectAnswers.length}</p>
                    <p>Unanswered/Skipped: ${quizData.length - userAnswers.length}</p>
                    
                    ${incorrectAnswers.length > 0 ? 
                        `<button id="explain-btn">EXPLAIN INCORRECT ANSWERS</button>` : 
                        `<p style="color: var(--rune-glow); margin-top: 20px;">No incorrect answers to explain. Flawless Victory!</p>`
                    }

                    <div id="explanation-area">
                        <p id="gemini-status" class="gemini-loading" style="display: none;">Generating explanations via Gemini AI...</p>
                    </div>

                    <button onclick="window.location.reload()" style="margin-top: 30px;">RESTART QUIZ</button>
                </section>
            `;
            
            if (incorrectAnswers.length > 0) {
                document.getElementById('explain-btn').addEventListener('click', () => {
                    generateExplanations(incorrectAnswers);
                });
            }
        }

        /**
         * Renders the Error Screen.
         */
        function renderErrorScreen(message = "An unknown error occurred.") {
            appContainer.innerHTML = `
                <header>
                    <h1><span class="title-rune">SYSTEM ERROR:</span> GATE FAILURE</h1>
                </header>
                <section id="error-screen">
                    <p>The system encountered a critical fault.</p>
                    <p style="font-style: italic;">Details: ${message}</p>
                    <button onclick="window.location.reload()">RELOAD SYSTEM</button>
                </section>
            `;
            clearInterval(timerInterval);
        }
        
        // --- QUIZ FLOW LOGIC ---

        /**
         * Initiates the quiz.
         */
        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            timeLimitSeconds = 600; // Reset time
            currentScreen = 'quiz';
            renderScreen();
        }

        /**
         * Records the user's answer and updates score/state.
         */
        function recordAnswer(question, selectedIndex) {
            const isCorrect = (selectedIndex === question.correct_answer);
            
            if (isCorrect) {
                score++;
            }
            
            userAnswers.push({
                id: question.id || `q-${currentQuestionIndex + 1}`,
                question_text: question.question_text,
                options: question.options,
                selected: selectedIndex,
                correct: question.correct_answer,
                correct_text: question.options[question.correct_answer],
                user_text: question.options[selectedIndex]
            });
        }

        /**
         * Ends the quiz and transitions to the results screen.
         */
        function finishQuiz() {
            clearInterval(timerInterval);
            currentScreen = 'results';
            renderScreen();
        }

        // --- TIMER LOGIC ---

        /**
         * Formats seconds into MM:SS string.
         */
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        /**
         * Starts the quiz countdown timer.
         */
        function startTimer() {
            clearInterval(timerInterval); // Clear any existing timer
            const timerDisplay = document.getElementById('timer-display');
            
            timerInterval = setInterval(() => {
                timeLimitSeconds--;
                if (timerDisplay) {
                    timerDisplay.textContent = formatTime(timeLimitSeconds);
                }

                if (timeLimitSeconds <= 0) {
                    clearInterval(timerInterval);
                    alert("Time's Up! You ran out of time, Hunter!");
                    finishQuiz();
                }
            }, 1000);
        }

        // --- DATA LOADING & INITIALIZATION ---

        /**
         * Fetches and parses the external questions.json file.
         */
        async function loadQuizData() {
            try {
                const response = await fetch('questions.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Flatten the subject structure into a single quizData array
                const allQuestions = [];
                for (const subject in data.subjects) {
                    allQuestions.push(...data.subjects[subject]);
                }
                
                // Shuffle and limit questions to a reasonab
                const shuffledQuestions = allQuestions.sort(() => 0.5 - Math.random());
                quizData = shuffledQuestions.slice(0, 10); 
                totalQuestions = quizData.length;
                
                // Update total questions on welcome screen if it's visible
                const startBtn = document.getElementById('start-quiz-btn');
                if (startBtn) {
                    startBtn.textContent = 'LEVEL UP START';
                    const nameInput = document.getElementById('user-name');
                    const keyInput = document.getElementById('gemini-api-key');
                    startBtn.disabled = !(nameInput.value.trim() && keyInput.value.trim() && totalQuestions > 0);
                }
                
            } catch (error) {
                console.error("Failed to load questions.json:", error);
                renderErrorScreen(`Could not load quiz questions: ${error.message}. Ensure 'questions.json' is present.`);
            }
        }

        // --- GEMINI API INTEGRATION ---

        /**
         * Generates explanations for incorrect answers using the Gemini API.
         */
        async function generateExplanations(incorrectAnswers) {
            const explanationArea = document.getElementById('explanation-area');
            const statusText = document.getElementById('gemini-status');
            const explainBtn = document.getElementById('explain-btn');
            
            statusText.style.display = 'block';
            explainBtn.disabled = true;
            explanationArea.innerHTML = ''; // Clear previous content

            try {
                for (const answer of incorrectAnswers) {
                    const prompt = `Explain why the correct answer is "${answer.correct_text}" (Option ${String.fromCharCode(65 + answer.correct)}) and why "${answer.user_text}" (Option ${String.fromCharCode(65 + answer.selected)}) is wrong for this ECET question: "${answer.question_text}"`;
                    
                    const card = document.createElement('div');
                    card.className = 'explanation-card';
                    card.innerHTML = `<h3>Q: ${answer.question_text.substring(0, 70)}...</h3><p class="gemini-loading">Loading explanation...</p>`;
                    explanationArea.appendChild(card);
                    
                    const geminiResponse = await callGeminiAPI(prompt);
                    
                    // Sanitize and replace loading text
                    card.innerHTML = `<h3>Q: ${answer.question_text}</h3><p><strong>Your Answer:</strong> ${answer.user_text}</p>
                                    <p><strong>Correct Answer:</strong> ${answer.correct_text}</p>
                                    <hr style="border-color: #3a4048;">
                                    ${geminiResponse}`; // Explanation content
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                explanationArea.innerHTML += `<div class="explanation-card">
                    <h3>SYSTEM ERROR: AI-GATE FAILED</h3>
                    <p>Could not retrieve explanations. Please check your **Gemini API Key** and ensure **CORS** is not blocking the request (may require a proxy/server-side call in a real deployment).</p>
                    <p style="font-size: 0.9em; color: #aaa;">Raw Error: ${error.message}</p>
                    <hr>
                    <p><strong>Fallback:</strong> Original Incorrect Questions:</p>
                    ${incorrectAnswers.map(a => `<p style="margin-bottom: 5px;">- Q: ${a.question_text.substring(0, 50)}... | Correct: ${a.correct_text}</p>`).join('')}
                </div>`;
            } finally {
                statusText.style.display = 'none';
                explainBtn.disabled = false;
            }
        }

        /**
         * Sends a request to the Gemini API.
         */
        async function callGeminiAPI(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`;
            
            // Basic validation for the key format
            if (!geminiApiKey.startsWith('AIza')) {
                 throw new Error("Invalid API Key format. Must start with 'AIza...'.");
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    config: {
                        "temperature": 0.2
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `API call failed with status ${response.status}`);
            }

            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }


        // --- ANIMATION / STARFIELD LOGIC (Lightweight Canvas) ---

        function initStarfield() {
            const canvas = document.getElementById('starfield');
            const ctx = canvas.getContext('2d');
            let width, height;
            let stars = [];
            const numStars = 100;
            
            function resizeCanvas() {
                width = canvas.width = window.innerWidth;
                height = canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 2,
                    speed: (Math.random() * 0.5) + 0.1,
                    alpha: (Math.random() * 0.5) + 0.5
                });
            }

            function animate() {
                ctx.clearRect(0, 0, width, height);

                for (let i = 0; i < numStars; i++) {
                    const star = stars[i];

                    // Update position
                    star.x -= star.speed;

                    // Wrap star around
                    if (star.x < 0) {
                        star.x = width;
                        star.y = Math.random() * height;
                    }

                    // Draw star (glowing effect)
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size / 2, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                    ctx.shadowColor = 'rgba(0, 255, 127, 0.8)'; // Rune glow color
                    ctx.shadowBlur = star.size * 3;
                    ctx.fill();
                    ctx.shadowBlur = 0; // Reset shadow for next element
                }

                requestAnimationFrame(animate);
            }

            animate();
        }

        // --- INITIALIZATION ---
        
        // Load data first, then render the welcome screen
        loadQuizData().then(() => {
            // Ensure the start button text/state is correct after loading
            renderScreen(); 
        }); 

        // Start the background animation
        initStarfield();

    </script>
</body>
</html>